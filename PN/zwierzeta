#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <stdbool.h>
#include <ctype.h>

// Typ wyliczeniowy z hashami

typedef enum {
    Animal_kot   = 193497299,
    Animal_pies  = 2090616342,
    Animal_krowa = 265267497,
    Animal_kon   = 193497293,
    Animal_malpa = 267024912,
} Animal_t;

// Funkcja hashująca z konwersją na małe litery

uint32_t hash(char *str) {
    uint32_t hash = 5381;
    int c;
    while ((c = *str++)) {
        // Konwersja na lower-case przed hashowaniem
        hash = ((hash << 5) + hash) + tolower(c);
    }
    return hash;
}


// Zapisuje ciąg znaków do pliku

bool file_save_txt(const char *path, char *string) {
    FILE *fp = fopen(path, "w");
    if (fp == NULL)
        return false;
    
    fprintf(fp, "%s", string);
    fclose(fp);
    return true; 
}


// Ładuje zawartość pliku do zaalokowanej pamięci

int file_load_txt(const char *name, char **bytes) {
    FILE *fp = fopen(name, "rb");
    if (fp == NULL) {
        *bytes = NULL;
        return -1;
    }

    fseek(fp, 0, SEEK_END);
    long size = ftell(fp);
    fseek(fp, 0, SEEK_SET);

    *bytes = (char *)malloc(size + 1);
    if (*bytes == NULL) {
        fclose(fp);
        return -3;
    }

    size_t read_size = fread(*bytes, 1, size, fp);
    fclose(fp);

    if (read_size != (size_t)size) {
        free(*bytes);
        return -2;
    }

    (*bytes)[size] = '\0'; // Zakończenie stringa
    return (int)size;
}

int main(void) {
    // Test
    file_save_txt("test.txt", "KOT"); 

    char *animal_type = NULL;
    int result = file_load_txt("test.txt", &animal_type);

    if (result < 0) {
        printf("Blad wczytywania pliku: %d\n", result);
        return 1;
    }

    uint32_t animal_hash = hash(animal_type);

    switch (animal_hash) {
        case Animal_kot:   printf("miau!\n"); break;
        case Animal_pies:  printf("hau-hau!\n"); break;
        case Animal_krowa: printf("mmuuuuuuuu!\n"); break;
        case Animal_kon:   printf("iiyiy-hahah!\n"); break;
        case Animal_malpa: printf("uu-aaaaa!\n"); break;
        default:           printf("Nieznane zwierze (hash: %u)\n", animal_hash); break;
    }

    // Zwolnienie pamięci
    free(animal_type);

    return 0;
}
